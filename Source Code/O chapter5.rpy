label chapter5_o:
    # 初始化变量
    $ 雨夜选择1 = ""
    $ 雨夜选择2 = ""
    $ 雨夜选择3 = ""
    $ 雨夜选择4 = ""
    $ 雨夜选择5 = ""
    $ 羁绊值 = 0
    $ 绝望度 = 0

    # 停止现有音频
    stop music fadeout 1.0
    stop sound fadeout 1.0
    
    # 播放雨夜环境音效
    if renpy.loadable("audio/rain_ambient.mp3"):
        play music "audio/rain_ambient.mp3" loop fadein 3.0
    else:
        play music "audio/1.mp3" loop fadein 3.0
    if renpy.loadable("audio/thunder_distant.mp3"):
        play sound "audio/thunder_distant.mp3" loop volume 0.5
    else:
        play sound "audio/1.mp3" loop volume 0.5
    
    # 场景：雨夜走廊
    scene bg mansion_corridor_rainy:
        zoom 1.4
    with fade
    
    # 环境描写
    C "（雨如泪，风如叹，宅邸在暴雨中颤抖。雨砸屋檐，水帘垂落，湿泥土气刺鼻。）"
    C "（风卷雨，湿榻榻米。灯笼摇晃，光影乱，我心如碎。雷轰，宅邸震，仿佛天地为我罪咎哭泣。）"
    C "（宅邸空寂，雨雷声掩一切。仆从避开，只我们，在风雨中寻希望。）"

    # 绪奈对话
    O "（蜷缩，雨湿衣，声音被雨吞）少主……我不想为难您。见您争执，我心如刀……"

    # 伊织回应
    I "（靠柱，疲惫）绪奈，不是你的错。是传统无情。"
    I "（握拳松）恨自己，为何继承人，甩不掉责任。"

    # 第一个选择
    menu:
        "「怕他为我担太多」":
            O "（泪眼）您不该担这些……是我害您……"
            I "（蹲下，拭泪）你是我坚持的理由，不是负担。"
            $ 雨夜选择1 = "温柔"
            $ 羁绊值 += 3
            $ 绝望度 -= 2
            
        "「怨时代残酷」":
            O "（低头）时代错，门第世道……武士家真苦。"
            I "（望雨）我们没错，错的是时代。"
            I "（苦笑）连爱人都选不了。"
            $ 雨夜选择1 = "哲理"
            $ 羁绊值 += 1
            $ 绝望度 += 1
            
        "「盼他找办法」":
            O "（小声）少主……有办法吧？我想和您一起……"
            I "（坚定）不能认输。我会找到办法。"
            I "（握手）给我时间。"
            $ 雨夜选择1 = "决心"
            $ 羁绊值 += 2
            $ 绝望度 -= 1

    # 绪奈提出离开
    O "（泪混雨）我离开，您能继承……我该消失……"

    # 第二个选择
    menu:
        "「怕他因我痛」":
            O "（心痛）别说傻话……我走，您心会碎？"
            I "（拥怀）没你，我心死了。"
            $ 雨夜选择2 = "拥抱"
            $ 羁绊值 += 4
            $ 绝望度 -= 3
            
        "「想一起面对」":
            O "（握肩）逃避无用，我们面对……对吗？"
            I "（坚定）我要和你找出路，不是牺牲。"
            $ 雨夜选择2 = "坚定"
            $ 羁绊值 += 2
            $ 绝望度 += 0
            
        "「自责沉默」":
            O "（低头）……分开最好。"
            I "（转背）别这样说，求你。"
            $ 雨夜选择2 = "沉默"
            $ 羁绊值 += 1
            $ 绝望度 += 2

    # 伊织安慰
    I "（揉眉）绪奈，不是你的错，传统固执，我们如雨中叶子。"

    # 第三个选择
    menu:
        "「忆童年温暖」":
            O "（恍惚）樱树下，我们说永远……我磨墨……"
            I "（微笑）你说磨一辈子墨。"
            $ 雨夜选择3 = "回忆"
            $ 羁绊值 += 2
            $ 绝望度 -= 1
            
        "「忧局势无望」":
            O "（叹）父亲强硬，萨摩施压……有希望吗？"
            I "（沉思）家老会议或转机。"
            $ 雨夜选择3 = "理智"
            $ 羁绊值 += 1
            $ 绝望度 += 0
            
        "「怕他恐惧成真」":
            O "（颤抖）您怕失我，辜负父亲……？"
            I "（低头）压力要窒息我。"
            $ 雨夜选择3 = "脆弱"
            $ 羁绊值 += 3
            $ 绝望度 += 2

    # 绪奈再次提出离开
    O "（激动）我离开，您幸福。我去京都或出家。"

    # 第四个选择
    menu:
        "「不愿他反对」":
            O "（心碎）不行？您弃一切？"
            I "（站起）不行！不让你牺牲！"
            $ 雨夜选择4 = "激烈"
            $ 羁绊值 += 3
            $ 绝望度 -= 2
            
        "「求他冷静」":
            O "（泪涌）冷静……逃避只痛两人……"
            I "（认真）要一起面对，不是牺牲。"
            $ 雨夜选择4 = "冷静"
            $ 羁绊值 += 2
            $ 绝望度 += 0
            
        "「同意分开」":
            O "（出神）分开最好……"
            I "（低声）或许……"
            $ 雨夜选择4 = "妥协"
            $ 羁绊值 -= 1
            $ 绝望度 += 3

    # 伊织表达决心
    I "（握手）不会让你走。我们一起面对，有办法。"
    I "（坚定）相信我。"

    # 第五个选择
    menu:
        "「问计划」":
            O "（低声）家老支持？会议有转机？"
            I "（坚定）给我时间，两全。"
            $ 雨夜选择5 = "计划"
            $ 羁绊值 += 2
            $ 绝望度 -= 1
            
        "「给信任」":
            O "（深看）我信您，给时间……"
            I "（恳切）我比谁都想护你。"
            $ 雨夜选择5 = "信任"
            $ 羁绊值 += 3
            $ 绝望度 += 0
            
        "「安慰无力」":
            O "（苦笑）您的努力，我知……再忍耐……"
            I "（低沉）再忍耐，好吗？"
            $ 雨夜选择5 = "恳求"
            $ 羁绊值 += 1
            $ 绝望度 += 1

    # 绪奈回应
    O "（点头）好。我信您。不后悔。"
    O "（握紧）若无法，以家族为重。我可离开。"

    # 环境描写
    C "（闪电照泪痕。雷预示艰难。）"
    C "（相拥，雨湿衣，温暖不灭。）"

    # 回忆场景
    scene bg garden_spring:
        zoom 1.3
        matrixcolor TintMatrix("#ffddaa") * SaturationMatrix(0.6) * BrightnessMatrix(0.1)
    with fade
    C "（雷声中，忆午后，樱花飘，少主笑我编环。）"
    show y young neutral1 at small_lowered_right with moveinleft:
        matrixcolor TintMatrix("#ffddaa") * SaturationMatrix(0.6) * BrightnessMatrix(0.1)
    show s young neutral1 at small_lowered_left with moveinleft:
        matrixcolor TintMatrix("#ffddaa") * SaturationMatrix(0.6) * BrightnessMatrix(0.1)
    I "（笑）又做孩子气的东西？"
    O "（微笑）给少主，好运。"
    I "（接环）武士靠自己。"
    O "（狡黠）要还是不要？"

    C "（那时无忧，命运已标价。）"

    # 回到雨夜场景
    scene bg mansion_corridor_rainy:
        zoom 1.4
    with fade
    C "（雷惊醒。我抖，冷或怕。）"
    I "（搂紧）冷吗？"
    O "（摇头）有您，不冷。"

    # 伊织内心独白
    I "（独白）绪奈，我护你，与世为敌。"
    I "（坚定）父亲、萨摩，来吧，我不退。"

    # 环境音效
    C "（脚步声被雨掩，熟悉节奏提心。）"

    # 应对脚步声的选择
    menu:
        "「怕被发现」":
            O "（心慌）有人……躲屏风后？"
            I "（拉起）不能被看到。"
            $ 绝望度 += 2
            
        "「求镇定」":
            O "（握手）避雨而已，对吗？"
            I "（镇定）慌张易起疑。"
            $ 绝望度 += 1
            
        "「让他迎去」":
            O "（担忧）谁来？传话？"
            I "（护身后）看看。"
            $ 绝望度 += 0

    # 环境描写
    C "（脚步犹豫，远去。紧张不散。）"

    # 告别
    O "（低声）我先回，太危险。"
    I "（不舍）好。相信我。"
    O "（点头）一直信。"

    C "（他消失雨中，我不安，如永别。）"

    # 淡出音效和画面
    scene black with fade

    # 结尾独白
    C "（雨夜誓言成回忆，珍贵而痛。雨来，我忆坚定眼睛，拥抱。）"
    C "（少主忆颤抖身影，承诺。记忆如雨，甜蜜疼痛。）"
    C "（命运如雨，来去突然。雨晴，一切变，留回忆泪痕。）"

    # 保存游戏数据
    $ persistent.chapter5_completed = True
    $ persistent.雨夜选择1 = 雨夜选择1
    $ persistent.雨夜选择2 = 雨夜选择2
    $ persistent.雨夜选择3 = 雨夜选择3
    $ persistent.雨夜选择4 = 雨夜选择4
    $ persistent.雨夜选择5 = 雨夜选择5
    $ persistent.羁绊值 = 羁绊值
    $ persistent.绝望度 = 绝望度
    $ persistent.perspective = "O"
    
    # 解锁进度
    if persistent.chapters_unlocked < 6:
        $ persistent.chapters_unlocked = 6

    # 根据羁绊值和绝望度选择结局
    if 羁绊值 >= 10 and 绝望度 <= 5:
        jump waiting_elope_ending_o
    else:
        jump ending_5

# 等待私奔结局（绪奈视角）
label waiting_elope_ending_o:
    scene bg garden_spring: 
        zoom 1.3
    with fade
    C "（春风吹樱花，庭院如梦。少主筹划月余，家老暗助，然时机未至，需耐心等待。）"
    O "（泪眼朦胧）少主，我们何时才能离开？我怕……但有您在，我便有勇气等待。"
    I "（紧握双手）绪奈，我们必须等待最佳时机。现在离开太过危险，父亲的眼线无处不在。"
    O "（低头轻叹）可是家族……他们会更加怨恨我们这样拖延……"
    I "（目光坚定）我明白这很艰难，但贸然行动只会让我们失去一切。我们需要更周密的计划，更稳妥的时机。"
    C "（他们相拥在樱花树下，花瓣缓缓飘落，仿佛时间也为他们的爱情驻足。等待虽苦，但为了更长久的相守，他们选择忍耐。）"
    C "（日复一日，他们在暗中筹备，观察着家族动向，等待着那个命运转折的时刻。）"
    C "（这份等待，既是对爱情的坚守，也是对未来的期盼。他们知道，唯有耐心，方能迎来真正的自由。）"
    C "（可惜，等不到了...)"
    call screen chapter_complete(5)
    return

# 直接私奔结局（绪奈视角）
label ending_5:
    scene bg garden_winter2: 
        zoom 1.5
        matrixcolor TintMatrix("#ee3608") * SaturationMatrix(0.6) * BrightnessMatrix(0.1)
    with fade
    C "（雪舞，寒风刺。我们不顾逃，武士追，箭破空。）"
    O "（气弱，泪流）少主……我连累您……无悔和您一起……"
    I "（抱紧，血流）绪奈，抱歉，没护好你。"
    O "（微笑）能死您怀中，我满足……来世再会……"
    I "（哽咽）若有来世，我给幸福……"
    C "（箭雨中，相拥倒下，血染雪，樱树叹遗憾。）"
    C "（或雪夜，我体弱，冻僵少主怀。）"
    O "（微弱）少主……我爱您……永远……"
    I "（割腕）不让你独行……一起去另一个世界。"
    C "（相拥而逝，雪掩身，遗憾如冰，冻未竟梦。）"
    $ persistent.endings_unlocked["ending_5"] = True
    $ progress = check_hidden_ending()
    C "达成结局：生死与共！当前收集：[progress]/9"
    C "（完）"
    stop music fadeout 1.0
    stop sound fadeout 1.0
    call screen chapter_select()
    return