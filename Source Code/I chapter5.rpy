label chapter5_i:
    # 初始化变量
    $ 雨夜选择1 = ""
    $ 雨夜选择2 = ""
    $ 雨夜选择3 = ""
    $ 雨夜选择4 = ""
    $ 雨夜选择5 = ""
    $ 羁绊值 = 0
    $ 绝望度 = 0

    # 停止现有音频
    stop music fadeout 1.0
    stop sound fadeout 1.0
    
    # 播放雨夜环境音效
    if renpy.loadable("audio/rain_ambient.mp3"):
        play music "audio/rain_ambient.mp3" loop fadein 3.0
    else:
        play music "audio/1.mp3" loop fadein 3.0
    if renpy.loadable("audio/thunder_distant.mp3"):
        play sound "audio/thunder_distant.mp3" loop volume 0.5
    else:
        play sound "audio/1.mp3" loop volume 0.5
    
    # 场景：雨夜走廊
    scene bg mansion_corridor_rainy:
        zoom 1.4
    with fade
    
    # 内心独白：环境描写
    C "（暴雨如刀，狂风撕扯宅邸，像命运在咆哮。雨点砸屋檐，震耳欲聋，水帘垂落。走廊湿冷，泥土气混木味，每吸一口气都像吞铅。）"
    C "（风卷雨侵，湿榻榻米。灯笼摇晃，光影不安，如我的心在风暴中挣扎。雷声轰鸣，宅邸震颤，仿佛天地为我们的反抗而怒。）"
    C "（宅邸空寂，只剩雨雷声。仆从避开，只我们两人，在风雨中寻找希望。）"

    # 绪奈对话
    O "（蜷缩，雨湿衣摆，声音被雨淹）少主……我不想您为难。见您与家主争，我心如刀割……"

    # 伊织对话
    I "（靠柱，疲惫，眼下阴影）绪奈，不是你的错。是家族腐朽规矩太无情。"
    I "（握拳松开）我恨自己，为何是继承人，为何甩不掉责任。"

    # 第一个选择
    menu:
        "「你不该承担这些」":
            I "（蹲下，平视，温柔）这一切不该你担。我该道歉，没护好你。"
            I "（拭泪）你是我坚持的理由，不是负担。"
            $ 雨夜选择1 = "温柔"
            $ 羁绊值 += 3
            $ 绝望度 -= 2
            
        "「时代错了」":
            I "（望雨，沉重）我们没错，错的是时代，门第世道。"
            I "（苦笑）武士连爱人都选不了，真讽刺。"
            $ 雨夜选择1 = "哲理"
            $ 羁绊值 += 1
            $ 绝望度 += 1
            
        "「我会找到办法」":
            I "（坚定）不能认输。我会找到办法，和你一起。"
            I "（握手）给我时间，绪奈。"
            $ 雨夜选择1 = "决心"
            $ 羁绊值 += 2
            $ 绝望度 -= 1

    # 绪奈回应
    O "（泪混雨）若我离开，您能继承，不再为难……我该消失……"

    # 第二个选择
    menu:
        "「拥抱她」":
            I "（拥怀，手抖）别说傻话！没你，家业何用？"
            I "（哽咽）你走，我心死了。"
            $ 雨夜选择2 = "拥抱"
            $ 羁绊值 += 4
            $ 绝望度 -= 3
            
        "「握肩膀」":
            I "（握肩，目光灼）逃避没用，要面对。"
            I "（坚定）我要和你找出路，不是牺牲。"
            $ 雨夜选择2 = "坚定"
            $ 羁绊值 += 2
            $ 绝望度 += 0
            
        "「沉默转身」":
            I "（转背，沉默，拳紧）别这样说，求你。"
            $ 雨夜选择2 = "沉默"
            $ 羁绊值 += 1
            $ 绝望度 += 2

    # 伊织继续对话
    I "（揉眉，雨更大）绪奈，不是你的错，是传统固执，我们如雨中叶子，身不由己。"

    # 第三个选择
    menu:
        "「忆童年」":
            I "（恍惚）记得樱树下，我们说永远一起。"
            I "（微笑）你说磨一辈子墨。"
            $ 雨夜选择3 = "回忆"
            $ 羁绊值 += 2
            $ 绝望度 -= 1
            
        "「分析局势」":
            I "（冷静）父亲强硬，萨摩施压。但有机会。"
            I "（沉思）家老会议获支持，或有转机。"
            $ 雨夜选择3 = "理智"
            $ 羁绊值 += 1
            $ 绝望度 += 0
            
        "「表达恐惧」":
            I "（颤抖）我怕，绪奈。怕失你，怕辜负，怕家族蒙羞。"
            I "（低头）压力要窒息我。"
            $ 雨夜选择3 = "脆弱"
            $ 羁绊值 += 3
            $ 绝望度 += 2

    # 绪奈提出离开
    O "（激动）若我离开，您幸福。我去京都或出家。"

    # 第四个选择
    menu:
        "「激烈反对」":
            I "（站起，颤抖）不行！"
            I "（吼）宁愿弃一切，不让你牺牲！"
            $ 雨夜选择4 = "激烈"
            $ 羁绊值 += 3
            $ 绝望度 -= 2
            
        "「冷静劝说」":
            I "（深吸气）绪奈，逃避只让两人痛。"
            I "（认真）要一起面对，不是牺牲。"
            $ 雨夜选择4 = "冷静"
            $ 羁绊值 += 2
            $ 绝望度 += 0
            
        "「同意妥协」":
            I "（出神）或许分开最好。"
            $ 雨夜选择4 = "妥协"
            $ 羁绊值 -= 1
            $ 绝望度 += 3

    # 伊织表达决心
    I "（握手，冷）不会让你走。我们一起面对，有办法。"
    I "（疲惫却坚定）相信我，绪奈。"

    # 第五个选择
    menu:
        "「说明计划」":
            I "（低声）联系了家老，他们会在会议支持。"
            I "（坚定）给我时间，两全。"
            $ 雨夜选择5 = "计划"
            $ 羁绊值 += 2
            $ 绝望度 -= 1
            
        "「求信任」":
            I "（深看）不求理解，只求信任，给我时间。"
            I "（恳切）我比谁都想护你。"
            $ 雨夜选择5 = "信任"
            $ 羁绊值 += 3
            $ 绝望度 += 0
            
        "「表达无力」":
            I "（苦笑）虽像空承诺，我在努力。"
            I "（低沉）再忍耐，好吗？"
            $ 雨夜选择5 = "恳求"
            $ 羁绊值 += 1
            $ 绝望度 += 1

    # 绪奈回应
    O "（点头，泪涌）好。我信您。无论结果，不后悔。"
    O "（握紧）若无法，以家族为重。我可离开。"

    # 环境描写
    C "（闪电照泪痕。雷预示艰难。）"
    C "（相拥，雨湿衣，火不灭。）"

    # 回忆场景
    scene bg garden_spring:
        zoom 1.3
        matrixcolor TintMatrix("#ffddaa") * SaturationMatrix(0.6) * BrightnessMatrix(0.1)
    with fade
    C "（雷声中，忆阳光午后，樱花飘，绪奈编草环。）"
    show y young neutral1 at small_lowered_right with moveinleft:
        matrixcolor TintMatrix("#ffddaa") * SaturationMatrix(0.6) * BrightnessMatrix(0.1)
    show s young neutral1 at small_lowered_left with moveinleft:
        matrixcolor TintMatrix("#ffddaa") * SaturationMatrix(0.6) * BrightnessMatrix(0.1)
    I "（笑）又做孩子气的东西？"
    O "（微笑）给少主，好运。"
    I "（接环）武士靠自己。"
    O "（狡黠）要还是不要？"

    C "（那时无忧，命运已标价。）"

    # 回到雨夜场景
    scene bg mansion_corridor_rainy:
        zoom 1.4
    with fade
    C "（雷惊醒。绪奈抖，冷或怕。）"
    I "（搂紧）冷吗？"
    O "（摇头）有您，不冷。"

    # 伊织内心独白
    I "（独白）绪奈，我护你，与世为敌。"
    I "（坚定）父亲、萨摩，来吧，我不退。"

    # 环境音效
    C "（脚步声被雨掩，熟悉节奏提心。）"

    # 应对脚步声的选择
    menu:
        "「躲藏」":
            I "（警觉）有人！躲屏风后。"
            I "（拉起）不能被看到。"
            $ 绝望度 += 2
            
        "「镇定」":
            I "（握手）别怕，避雨而已。"
            I "（镇定）慌张易起疑。"
            $ 绝望度 += 1
            
        "「迎上去」":
            I "（凛）看看谁来。"
            I "（护身后）或传话。"
            $ 绝望度 += 0

    # 环境描写
    C "（脚步犹豫，远去。紧张不散。）"

    # 告别
    O "（低声）我先回，太危险。"
    I "（不舍）好。相信我。"
    O "（点头）一直信。"

    C "（她消失雨中，我不安，如永别。）"

    # 淡出音效和画面
    scene black with fade

    # 结尾独白
    C "（雨夜誓言成回忆，珍贵而痛。雨来，我忆颤抖身影，承诺。）"
    C "（绪奈忆坚定眼睛，拥抱，‘一起面对’。记忆如雨，甜蜜疼痛。）"
    C "（命运如雨，来去突然。雨晴，一切变，留回忆泪痕。）"

    # 保存游戏数据
    $ persistent.chapter5_completed = True
    $ persistent.雨夜选择1 = 雨夜选择1
    $ persistent.雨夜选择2 = 雨夜选择2
    $ persistent.雨夜选择3 = 雨夜选择3
    $ persistent.雨夜选择4 = 雨夜选择4
    $ persistent.雨夜选择5 = 雨夜选择5
    $ persistent.羁绊值 = 羁绊值
    $ persistent.绝望度 = 绝望度
    $ persistent.perspective = "I"
    
    # 解锁进度
    if persistent.chapters_unlocked < 6:
        $ persistent.chapters_unlocked = 6

    # 根据羁绊值和绝望度选择结局
    if 羁绊值 >= 10 and 绝望度 <= 5:
        jump waiting_elope_ending_i
    else:
        jump ending_1

# 等待私奔结局
label waiting_elope_ending_i:
    scene bg garden_spring: 
        zoom 1.3
        matrixcolor TintMatrix("#2feb09") * SaturationMatrix(0.6) * BrightnessMatrix(0.1)
    with fade
    C "（春风轻拂，樱花如雪，庭院沐浴阳光。我与绪奈筹划数月，老家臣暗中相助，然时机尚未成熟。）"
    I "（紧握双手，目光深邃）还需等待。现在离开太过冒险，父亲的眼线比想象中更多。"
    O "（眼中含泪却微笑）我明白，少主。无论等待多久，只要与您一起，我都愿意。"
    I "（轻抚她的发丝）我们要选择最稳妥的时机，不能辜负老家臣们的苦心安排。"
    O "（低头轻声）可是家族那边...您的父亲一定会更加愤怒..."
    I "（坚定注视）正因如此才要更加谨慎。我们要的不是短暂的逃亡，而是长久的相守。"
    C "（他们相拥在樱花树下，花瓣缓缓飘落，时光仿佛为这份坚守而停留。等待虽苦，却是为了更美好的未来。）"
    C "（日复一日，他们在暗中观察时机，完善计划，每一个细节都反复推敲。）"
    C "（这份等待，是对爱情的考验，也是对智慧的磨练。他们知道，唯有最恰当的时机，才能换来真正的自由。）"
    C "（可惜，等不到了...)"
    call screen chapter_complete(5)
    return

# 直接私奔结局
label ending_1:
    scene bg garden_winter2: 
        zoom 1.5
        matrixcolor TintMatrix("#ee3608") * SaturationMatrix(0.6) * BrightnessMatrix(0.1)
    with fade
    C "（雪花飞舞，寒风刺骨。我们不顾一切逃离，武士追来，箭矢破空。）"
    I "（抱紧她，血流）绪奈，抱歉……我没护好你。”"
    O "（气弱，泪流）不，少主，是我连累您……能和您一起，我无悔……”"
    I "（哽咽）若有来世，我要给你幸福……不让命运再分开我们。”"
    C "（箭雨中，他们相拥倒下，血染白雪，樱树见证遗憾。）"
    C "（或雪夜，绪奈体弱，冻僵我怀。）"
    I "（割腕，血流）绪奈，我不让你独行……我们一起去另一个世界。”"
    O "（微弱）少主……我爱您……永远……”"
    C "（他们相拥而逝，雪掩身躯，遗憾如冰，冻结未竟的梦。）"
    $ persistent.endings_unlocked["ending_1"] = True
    $ progress = check_hidden_ending()
    C "达成结局：共赴黄泉！当前收集：[progress]/9"
    C "（完）"
    stop music fadeout 1.0
    stop sound fadeout 1.0
    call screen chapter_select()
    return